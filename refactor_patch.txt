===== START: CREATE_OR_REPLACE ./flake.nix =====
{
  description = "NixOS Configuration";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";

    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    # The input name is 'hardware', which is what we will use.
    hardware.url = "github:nixos/nixos-hardware";

    neovim-nightly-overlay.url = "github:nix-community/neovim-nightly-overlay";
  };

  outputs = { self, nixpkgs, home-manager, hardware, ... }@inputs:
  let
    system = "x86_64-linux";
    pkgs = import nixpkgs {
      inherit system;
      config.allowUnfree = true;
      overlays = [
        inputs.neovim-nightly-overlay.overlays.default
      ];
    };
  in
  {
    nixosConfigurations = {
      irnixos = nixpkgs.lib.nixosSystem {
        inherit system;
        specialArgs = { inherit inputs; };
        modules = [
          ./nixos/configuration.nix
          # THIS IS THE FIX: Using your original, working method.
          # The argument `hardware` matches the input name now.
          hardware.nixosModules.lenovo-thinkpad-p14s-amd-gen2
        ];
      };
    };

    homeConfigurations = {
      "irasikhin@irnixos" = home-manager.lib.homeManagerConfiguration {
        inherit pkgs;
        extraSpecialArgs = { inherit inputs; };
        modules = [ ./home-manager/home.nix ];
      };
    };
  };
}
===== END: CREATE_OR_REPLACE ./flake.nix =====

===== START: CREATE_OR_REPLACE ./nixos/configuration.nix =====
{
  config,
  pkgs,
  # Accept 'inputs' here to access the overlay
  inputs,
  lib,
  ...
}:

{
  imports = [
    ./hardware-configuration.nix
  ];

  # Add the overlay to the system's package set.
  # This is the idiomatic way to fix the `_module.args.pkgs` error.
  nixpkgs.overlays = [
    inputs.neovim-nightly-overlay.overlays.default
  ];


  # --- The rest of your configuration remains unchanged ---

  # Configure system bootloader
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  # Set hostname and networking settings
  networking.hostName = "irnixos";
  networking.wireless.enable = false;

  services.resolved = {
    enable = false;
    domains = [ "~." ];
  };
  networking.networkmanager = {
    enable = true;
    enableStrongSwan = true;
  };

  i18n.defaultLocale = "en_US.UTF-8";
  time.timeZone = "Europe/Moscow";

  i18n.extraLocaleSettings = {
    LC_ADDRESS = "ru_RU.UTF-8";
    LC_IDENTIFICATION = "ru_RU.UTF-8";
    LC_MEASUREMENT = "ru_RU.UTF-8";
    LC_MONETARY = "ru_RU.UTF-8";
    LC_NAME = "ru_RU.UTF-8";
    LC_NUMERIC = "ru_RU.UTF-8";
    LC_PAPER = "ru_RU.UTF-8";
    LC_TELEPHONE = "ru_RU.UTF-8";
    LC_TIME = "ru_RU.UTF-8";
  };

  services.xserver.enable = true;
  services.xserver.desktopManager.xfce.enable = false;
  services.xserver.displayManager.lightdm.enable = true;
  services.xserver.displayManager.lightdm.greeters.gtk.extraConfig = "user-background = false";
  services.displayManager.defaultSession = "none+i3";
  services.xserver.windowManager.i3 = {
    enable = true;
    extraPackages = with pkgs; [ rofi i3status-rust i3lock-color i3lock-fancy ];
  };
  services.xserver.xkb = {
    layout = "us,ru";
    options = "grp:shifts_toggle";
  };

  console.keyMap = "us";
  services.printing.enable = false;
  services.pulseaudio.enable = false;
  security.rtkit.enable = true;
  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
  };

  programs.firefox.enable = true;
  programs.gnupg.agent = {
    enable = true;
    enableSSHSupport = true;
  };

  services.openssh.enable = true;
  system.stateVersion = "24.05";
  nix.package = pkgs.nixVersions.stable;
  nix.extraOptions = "experimental-features = nix-command flakes";

  users.users.irasikhin = {
    isNormalUser = true;
    extraGroups = [ "networkmanager" "wheel" "video" "audio" "qemu-libvirtd" "docker" "libvirtd" ];
    shell = pkgs.zsh;
  };
  programs.zsh.enable = true;
  programs.tmux = {
    enable = true;
    clock24 = true;
  };

  services.interception-tools = {
    enable = true;
    plugins = [ pkgs.interception-tools-plugins.caps2esc ];
    udevmonConfig = ''
      - JOB: "${pkgs.interception-tools}/bin/intercept -g $DEVNODE | ${pkgs.interception-tools-plugins.caps2esc}/bin/caps2esc -m 1 | ${pkgs.interception-tools}/bin/uinput -d $DEVNODE"
        DEVICE:
          EVENTS:
            EV_KEY: [KEY_CAPSLOCK, KEY_ESC]
    '';
  };

  environment.variables = { GDK_SCALE = "1"; GDK_DPI_SCALE = "1.5"; };
  programs.light.enable = true;
  virtualisation.docker = {
    enable = true;
    storageDriver = "btrfs";
    daemon.settings = {
      "data-root" = "/home/irasikhin/.docker-data";
      "default-address-pools" = [{ base = "192.170.0.0/16"; size = 24; }];
    };
  };

  environment.systemPackages = with pkgs; [
    docker-compose freefilesync strongswan strongswanNM openssl
    python312Packages.pip-system-certs libvirt vagrant wireguard-tools
    tinyproxy xvfb-run swt distrobox dive podman-tui autoconf gnumake
    graphviz pandoc file gcc alsa-lib autossh clang clang-tools
  ];

  networking.firewall.enable = true;
  programs.nix-ld.enable = true;
  hardware.bluetooth = { enable = true; powerOnBoot = true; };
  services.blueman.enable = true;
  security.sudo.wheelNeedsPassword = false;
  virtualisation.virtualbox.host.enable = true;
  users.extraGroups.vboxusers.members = [ "irasikhin" ];
  nixpkgs.config.allowUnfree = true;
  nixpkgs.config.packageOverrides = pkgs: {
    vagrant = pkgs.vagrant.override { withLibvirt = false; };
  };

  services.tinyproxy = {
    enable = true;
    settings = {
      Port = 8888;
      Listen = "127.0.0.1";
      Timeout = 600;
      Allow = "127.0.0.1";
      Upstream = "socks5 127.0.0.1:1337";
    };
  };

  programs.java = {
    enable = true;
    package = pkgs.temurin-bin-21;
  };

  swapDevices = lib.mkForce [ ];
}
===== END: CREATE_OR_REPLACE ./nixos/configuration.nix =====

===== START: CREATE_OR_REPLACE ./home-manager/home.nix =====
# This is the main entrypoint for home-manager configuration.
# It imports all other modules.
{ ... }: {
  imports = [
    ./modules/cli.nix
    ./modules/gui.nix
    ./modules/shells.nix
    ./modules/programs/neovim.nix
    ./modules/programs/i3.nix
  ];

  # Basic user settings
  home.username = "irasikhin";
  home.homeDirectory = "/home/irasikhin";
  home.stateVersion = "24.05";

  home.sessionVariables = { EDITOR = "nvim"; };

  nixpkgs.config.allowUnfree = true;

  programs.home-manager.enable = true;
}
===== END: CREATE_OR_REPLACE ./home-manager/home.nix =====

===== START: CREATE_OR_REPLACE ./home-manager/modules/cli.nix =====
# Manages Command Line Interface tools
{ pkgs, ... }: {
  home.packages = with pkgs; [
    htop unzip zip git lazygit bat fzf ripgrep jq tree eza coreutils-prefixed fd
    cloc bc lshw gparted parted feh imagemagick sshpass oath-toolkit yamllint
    qrencode httpie skopeo nmap sops age aria2 proxychains speedtest-cli p7zip
    xarchiver tflint nixfmt-rfc-style treefmt nil ytt dive podman-tui autoconf
    gnumake graphviz pandoc file gcc autossh clang-tools python3 nodejs clang
    zig go-task maven cargo pnpm ansible_2_17 quarkus kind
    (pkgs.wrapHelm pkgs.kubernetes-helm {
      plugins = with pkgs.kubernetes-helmPlugins; [ helm-diff helm-secrets helm-s3 ];
    })
    helmfile kubectl kustomize jira-cli-go opentofu terragrunt
    openapi-generator-cli nh npins mergiraf
  ];

  home.shellAliases = { l = "eza"; ls = "eza"; cat = "bat"; };
}
===== END: CREATE_OR_REPLACE ./home-manager/modules/cli.nix =====

===== START: CREATE_OR_REPLACE ./home-manager/modules/gui.nix =====
# Manages Graphical User Interface applications
{ pkgs, ... }: {
  home.packages = with pkgs; [
    alacritty kitty pango fira-code (nerd-fonts.override { fonts = [ "FiraCode" ]; })
    font-awesome librewolf floorp ungoogled-chromium pass xclip brillo
    networkmanagerapplet openconnect networkmanager-openconnect networkmanager-vpnc
    autorandr xlayoutdisplay inkscape gimp jmeter libreoffice telegram-desktop
    (jetbrains.idea-community.override { plugins = []; })
    spotify vscode zoom-us obsidian insomnia httpie-desktop bruno yandex-disk yandex-music
  ];

  programs.alacritty.settings = {
    font = {
      size = 12.0;
      normal = { family = "FiraCode Nerd Font"; style = "Regular"; };
      bold = { family = "FiraCode Nerd Font"; style = "Bold"; };
      italic = { family = "FiraCode Nerd Font"; style = "Italic"; };
    };
  };
}
===== END: CREATE_OR_REPLACE ./home-manager/modules/gui.nix =====

===== START: CREATE_OR_REPLACE ./home-manager/modules/programs/i3.nix =====
{ pkgs, ... }:

let
  my-scripts = pkgs.runCommand "my-i3-scripts" { } ''
    mkdir -p $out/bin
    cp ${../../../scripts/double_mod_switch.sh} $out/bin/double_mod_switch
    cp ${../../../scripts/update_background_image.sh} $out/bin/update_background_image
    chmod +x $out/bin/*
  '';
in
{
  home.packages = [ my-scripts ];

  xdg.configFile."i3/config".text = ''
    set $mod Mod4
    set $alt Mod1
    default_border none
    font pango:FiraCode Nerd Font 12
    floating_modifier $mod
    workspace_auto_back_and_forth yes
    bindsym $mod+Return exec termite -e /bin/zsh
    bindsym $mod+Shift+q kill
    bindsym $mod+Shift+a focus parent,kill
    bindsym $alt+d exec "rofi -show combi -sidebar-mode"
    bindsym $mod+Tab exec "rofi -show window"
    bindsym $mod+j focus left
    bindsym $mod+k focus down
    bindsym $mod+l focus up
    bindsym $mod+semicolon focus right
    bindsym $mod+Left focus left
    bindsym $mod+Down focus down
    bindsym $mod+Up focus up
    bindsym $mod+Right focus right
    bindsym $mod+Shift+j move left
    bindsym $mod+Shift+k move down
    bindsym $mod+Shift+l move up
    bindsym $mod+Shift+semicolon move right
    bindsym $mod+Shift+Left move left
    bindsym $mod+Shift+Down move down
    bindsym $mod+Shift+Up move up
    bindsym $mod+Shift+Right move right
    bindsym $mod+h split h
    bindsym $mod+v split v
    bindsym $mod+f fullscreen toggle
    bindsym $mod+s layout stacking
    bindsym $mod+w layout tabbed
    bindsym $mod+e layout toggle split
    bindsym $mod+Shift+space floating toggle
    bindsym $mod+space focus mode_toggle
    bindsym $mod+a focus parent
    set $ws1 "1"
    set $ws2 "2"
    set $ws3 "3"
    set $ws4 "4"
    set $ws5 "5"
    set $ws6 "6"
    set $ws7 "7"
    set $ws8 "8"
    set $ws9 "9"
    set $ws10 "10"
    bindsym $mod+1 workspace $ws1
    bindsym $mod+2 workspace $ws2
    bindsym $mod+3 workspace $ws3
    bindsym $mod+4 workspace $ws4
    bindsym $mod+5 workspace $ws5
    bindsym $mod+6 workspace $ws6
    bindsym $mod+7 workspace $ws7
    bindsym $mod+8 workspace $ws8
    bindsym $mod+9 workspace $ws9
    bindsym $mod+0 workspace $ws10
    bindsym $mod+Shift+1 move container to workspace $ws1
    bindsym $mod+Shift+2 move container to workspace $ws2
    bindsym $mod+Shift+3 move container to workspace $ws3
    bindsym $mod+Shift+4 move container to workspace $ws4
    bindsym $mod+Shift+5 move container to workspace $ws5
    bindsym $mod+Shift+6 move container to workspace $ws6
    bindsym $mod+Shift+7 move container to workspace $ws7
    bindsym $mod+Shift+8 move container to workspace $ws8
    bindsym $mod+Shift+9 move container to workspace $ws9
    bindsym $mod+Shift+0 move container to workspace $ws10
    bindsym $mod+Shift+c reload
    bindsym $mod+Shift+r restart
    bindsym $mod+Shift+e exec "i3-nagbar -t warning -m 'You pressed the exit shortcut. Do you really want to exit i3? This will end your X session.' -B 'Yes, exit i3' 'i3-msg exit'"
    bindsym $mod+Shift+w exec "i3lock-color -k --keylayout 0 --image $HOME/.background-image"
    mode "resize" {
      bindsym j resize shrink width 10 px or 10 ppt
      bindsym k resize grow height 10 px or 10 ppt
      bindsym l resize shrink height 10 px or 10 ppt
      bindsym semicolon resize grow width 10 px or 10 ppt
      bindsym Left resize shrink width 10 px or 10 ppt
      bindsym Down resize grow height 10 px or 10 ppt
      bindsym Up resize shrink height 10 px or 10 ppt
      bindsym Right resize grow width 10 px or 10 ppt
      bindsym Return mode "default"
      bindsym Escape mode "default"
      bindsym $mod+r mode "default"
    }
    bindsym $mod+r mode "resize"
    bar {
      font pango: FiraCode Nerd Font 16
      position top
      status_command i3status-rs ~/.config/i3/status.toml
      colors {
        separator #666666
        background #222222
        statusline #dddddd
        focused_workspace #0088CC #0088CC #ffffff
        active_workspace #333333 #333333 #ffffff
        inactive_workspace #333333 #333333 #888888
        urgent_workspace #2f343a #900000 #ffffff
      }
    }
    focus_on_window_activation focus
    bindsym XF86AudioRaiseVolume exec --no-startup-id pamixer -i 5
    bindsym XF86AudioLowerVolume exec --no-startup-id pamixer -d 5
    bindsym XF86AudioMute exec --no-startup-id pamixer -t
    bindsym XF86MonBrightnessUp exec --no-startup-id brillo -A 5
    bindsym XF86MonBrightnessDown exec --no-startup-id brillo -U 5
    bindsym XF86AudioPlay exec playerctl play
    bindsym XF86AudioPause exec playerctl pause
    bindsym XF86AudioNext exec playerctl next
    bindsym XF86AudioPrev exec playerctl previous
    set $idea "idea"
    bindsym $mod+i workspace $idea
    assign [class=".*[I,i]dea.*"] $idea
    set $msg "msg"
    bindsym $mod+m workspace $msg
    assign [class=".*telegram-desktop.*"] $msg
    set $web "web"
    bindsym $mod+u workspace $web
    assign [class=".*[l,l]ibrewolf.*"] $web
    assign [class=".*[F,f]irefox.*"] $web
    assign [class=".*[C,c]hromium.*"] $web
    assign [class=".*[F,f]loorp.*"] $web
    set $discord "discord"
    bindsym $mod+d workspace $discord
    assign [class=".*[D,d]iscord.*"] $discord
    set $obsidian "obsidian"
    bindsym $mod+o workspace $obsidian
    assign [class=".*[O,o]bsidian.*"] $obsidian
    set $slack "slack"
    bindsym $mod+n workspace $slack
    assign [class=".*[S,s]lack.*"] $slack
    set $code "code"
    bindsym $mod+c workspace $code
    assign [class=".*[C,c]ode.*"] $code
    set $clion "clion"
    bindsym $mod+y workspace $clion
    assign [class=".*[C,c]lion.*"] $clion
    set $terminal "terminal"
    bindsym Super_L exec --no-startup-id "double_mod_switch"
    assign [class=".*[A,a]lacritty.*"] $terminal
    set $spotify "spotify"
    bindsym $mod+p workspace $spotify
    assign [class=".*[S,s]potify.*"] $spotify
    set $thunderbird "thunderbird"
    bindsym $mod+t workspace $thunderbird
    assign [class=".*[T,t]hunderbird.*"] $thunderbird
    for_window [class="^.*"] border pixel 0
    exec_always --no-startup-id nm-applet
    exec --no-startup-id i3-msg 'workspace $terminal; exec alacritty'
    exec --no-startup-id i3-msg 'workspace $web; exec floorp'
    exec --no-startup-id i3-msg 'workspace $idea; exec idea'
    exec --no-startup-id i3-msg 'workspace $msg; exec telegram-desktop'
    exec --no-startup-id i3-msg 'workspace $thunderbird; exec thunderbird'
    exec_always --no-startup-id "update_background_image"
  '';

  xdg.configFile."i3/status.toml".source = ../../dotfiles/i3/status.toml;
}
===== END: CREATE_OR_REPLACE ./home-manager/modules/programs/i3.nix =====

===== START: CREATE_OR_REPLACE ./home-manager/modules/programs/neovim.nix =====
# Fully declarative Neovim configuration
{ pkgs, ... }:

let
  toolPkgs = with pkgs; [
    jdtls clangd nil-ls rust-analyzer kotlin-language-server metals jsonls
    black stylua shfmt nixfmt-rfc-style shellcheck flake8 java-debug-adapter
    java-test fzf bat
  ];

  pluginPkgs = with pkgs.vimPlugins; [
    lazy-nvim LazyVim gruvbox-nvim darcula-dark-nvim onedark-nvim vscode-nvim
    darcula-solid-nvim github-nvim-theme fzf-lua which-key-nvim zen-mode-nvim
    (mini-nvim.withPlugins (p: [ p.files p.bufremove p.misc ]))
    plenary-nvim nvim-lspconfig nvim-treesitter.withAllGrammars nvim-cmp
    cmp-nvim-lsp conform-nvim maven-nvim refactoring-nvim nvim-jdtls
    clangd_extensions-nvim
  ];

in
{
  programs.neovim = {
    enable = true;
    package = pkgs.neovim;
    extraPackages = toolPkgs;
    plugins = pluginPkgs;
    viAlias = true;
    vimAlias = true;
    defaultEditor = true;
  };

  xdg.configFile."nvim" = {
    source = ../../dotfiles/nvim;
    recursive = true;
  };
}
===== END: CREATE_OR_REPLACE ./home-manager/modules/programs/neovim.nix =====

===== START: CREATE_OR_REPLACE ./home-manager/modules/shells.nix =====
# Manages shell configuration (zsh, tmux, etc.)
{ pkgs, ... }: {
  home.packages = with pkgs; [ screen tmux byobu zsh-autosuggestions antigen ];

  programs.zoxide = {
    enable = true;
    enableZshIntegration = true;
    options = [ "--cmd j" ];
  };

  programs.zsh = {
    enable = true;
    enableCompletion = true;
    autosuggestion.enable = true;
    syntaxHighlighting.enable = true;
    oh-my-zsh = {
      enable = true;
      plugins = [ "git" "docker" "fzf" "kubectl" "helm" ];
    };
    history = {
      size = 10000;
      ignoreAllDups = true;
      path = "$HOME/.zsh_history";
      ignorePatterns = [ "rm *" "pkill *" "cp *" ];
    };
    antidote = {
      enable = true;
      plugins = [ "zsh-users/zsh-autosuggestions" ];
    };
    initExtra = ''
      if command -v byobu >/dev/null 2>&1; then
        byobu
      fi
      if [ -f "$HOME/jira.sh" ]; then
        source "$HOME/jira.sh"
      fi
      tput reset
    '';
  };

  programs.tmux = {
    enable = true;
    sensibleOnTop = false;
    shortcut = "a";
    baseIndex = 1;
    newSession = true;
    escapeTime = 0;
    secureSocket = false;
    plugins = with pkgs.tmuxPlugins; [ better-mouse-mode ];
    extraConfig = ''
      set -g default-terminal "tmux-256color"
      set -ga terminal-overrides ",*256col*:Tc"
      set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'
      set-environment -g COLORTERM "truecolor"
      set-option -g mouse on
      bind | split-window -h -c "#{pane_current_path}"
      bind - split-window -v -c "#{pane_current_path}"
      bind c new-window -c "#{pane_current_path}"
    '';
  };

  programs.starship = {
    enable = true;
    settings = {
      add_newline = false;
      character = { success_symbol = "[➜](bold green)"; error_symbol = "[➜](bold red)"; };
      package.disabled = true;
    };
  };

  xdg.configFile."byobu" = {
    source = ../dotfiles/byobu;
    recursive = true;
  };
}
===== END: CREATE_OR_REPLACE ./home-manager/modules/shells.nix =====

===== START: CREATE_OR_REPLACE ./home-manager/dotfiles/nvim/lua/config/lazy.lua =====
-- Nix/home-manager is managing the installation of lazy.nvim and all plugins,
-- so we don't need to clone it manually. This file just configures it.

require("lazy").setup({
  spec = {
    { "LazyVim/LazyVim", import = "lazyvim.plugins" },
    { import = "plugins" },
  },
  defaults = {
    lazy = false,
    version = false,
  },
  install = { colorscheme = { "tokyonight", "habamax" } },
  checker = {
    enabled = true,
    notify = false,
  },
  performance = {
    rtp = {
      disabled_plugins = {
        "gzip", "tarPlugin", "tohtml", "tutor", "zipPlugin",
      },
    },
  },
})
===== END: CREATE_OR_REPLACE ./home-manager/dotfiles/nvim/lua/config/lazy.lua =====

===== START: CREATE_OR_REPLACE ./home-manager/dotfiles/nvim/lua/plugins/java/init.lua =====
return {
  "mfussenegger/nvim-jdtls",
  ft = { "java" },
  dependencies = { "folke/which-key.nvim" },
  config = function()
    local jdtls_setup = require("jdtls.setup")
    local root_dir = jdtls_setup.find_root({ ".git", "mvnw", "gradlew", "pom.xml" })
    if not root_dir then
      return
    end

    local project_name = vim.fn.fnamemodify(root_dir, ":p:h:t")
    local workspace_dir = vim.fn.stdpath("cache") .. "/jdtls/" .. project_name

    local config = {
      cmd = { "jdtls", "-Xmx4g", "-Xms1g", "--jvm-arg=-XX:+UseG1GC" },
      root_dir = root_dir,
      workspace_dir = workspace_dir,
      settings = {
        java = {
          inlayHints = { parameterNames = { enabled = "all" } },
        },
      },
      init_options = { bundles = {} },
      on_attach = function(client, bufnr)
        local wk = require("which-key")
        wk.add({
          {
            mode = "n",
            buffer = bufnr,
            { "<leader>cx", group = "extract" },
            { "<leader>cxv", function() require("jdtls").extract_variable_all(false) end, desc = "Extract Variable" },
            { "<leader>cxc", function() require("jdtls").extract_constant(false) end, desc = "Extract Constant" },
            { "<leader>cgs", require("jdtls").super_implementation, desc = "Goto Super" },
            { "<leader>cgS", require("jdtls.tests").goto_subjects, desc = "Goto Subjects" },
            { "<leader>co", require("jdtls").organize_imports, desc = "Organize Imports" },
          },
          {
            mode = "v",
            buffer = bufnr,
            { "<leader>cx", group = "extract" },
            { "<leader>cxm", [[<ESC><CMD>lua require('jdtls').extract_method(true)<CR>]], desc = "Extract Method" },
          },
        })

        require("jdtls").setup_dap({ hotcodereplace = "auto" })
        wk.add({
          {
            mode = "n",
            buffer = bufnr,
            { "<leader>t", group = "test" },
            { "<leader>tt", function() require("jdtls.dap").test_class() end, desc = "Run All Test" },
            { "<leader>tr", function() require("jdtls.dap").test_nearest_method() end, desc = "Run Nearest Test" },
            { "<leader>tT", require("jdtls.dap").pick_test, desc = "Run Test" },
          },
        })
      end,
    }

    require("jdtls").start_or_attach(config)
  end,
}
===== END: CREATE_OR_REPLACE ./home-manager/dotfiles/nvim/lua/plugins/java/init.lua =====

===== START: CREATE_OR_REPLACE ./scripts/double_mod_switch.sh =====
#!/usr/bin/env bash

LAST_PRESS_FILE="/tmp/last_mod_press"
DOUBLE_PRESS_TIME=0.15

current_time=$(date +%s.%N)

if [ -f "$LAST_PRESS_FILE" ]; then
  last_time=$(cat "$LAST_PRESS_FILE")
  diff=$(echo "$current_time - $last_time" | bc)

  if (($(echo "$diff < $DOUBLE_PRESS_TIME" | bc -l))); then
    i3-msg workspace terminal
    rm "$LAST_PRESS_FILE"
    exit 0
  fi
fi

echo "$current_time" >"$LAST_PRESS_FILE"
===== END: CREATE_OR_REPLACE ./scripts/double_mod_switch.sh =====

===== START: CREATE_OR_REPLACE ./scripts/update_background_image.sh =====
#!/usr/bin/env bash

SEARCH_DIR="$HOME/.config/wallpaper"
DEST_IMAGE="$HOME/.background-image"

if [ ! -d "$SEARCH_DIR" ]; then
    echo "Wallpaper directory not found: $SEARCH_DIR"
    exit 1
fi

mapfile -t image_files < <(find "$SEARCH_DIR" -type f \( -iname '*.jpg' -o -iname '*.png' -o -iname '*.jpeg' \))

if [ ${#image_files[@]} -eq 0 ]; then
    echo "No image files found in the specified directory."
    exit 1
fi

RANDOM_IMAGE="${image_files[RANDOM % ${#image_files[@]}]}"

cp "$RANDOM_IMAGE" "$DEST_IMAGE"
feh --bg-scale "$DEST_IMAGE"

echo "Set background to: $(basename "$RANDOM_IMAGE")"
===== END: CREATE_OR_REPLACE ./scripts/update_background_image.sh =====

===== START: DELETE ./home-manager/dotfiles/nvim/lua/plugins/example.lua =====
===== END: DELETE ./home-manager/dotfiles/nvim/lua/plugins/example.lua =====

===== START: DELETE ./home-manager/dotfiles/nvim/lua/plugins/treesitter/init.lua =====
===== END: DELETE ./home-manager/dotfiles/nvim/lua/plugins/treesitter/init.lua =====

===== START: DELETE ./home-manager/dotfiles/nvim/lua/plugins/telescope/init.lua =====
===== END: DELETE ./home-manager/dotfiles/nvim/lua/plugins/telescope/init.lua =====

===== START: DELETE ./home-manager/dotfiles/scripts/update_background_image.sh =====
===== END: DELETE ./home-manager/dotfiles/scripts/update_background_image.sh =====

===== START: DELETE ./home-manager/dotfiles/scripts/double_mod_switch.sh =====
===== END: DELETE ./home-manager/dotfiles/scripts/double_mod_switch.sh =====

===== START: DELETE ./home-manager/dotfiles/alacritty/alacritty.toml =====
===== END: DELETE ./home-manager/dotfiles/alacritty/alacritty.toml =====

===== START: DELETE ./home-manager/dotfiles/i3/config =====
===== END: DELETE ./home-manager/dotfiles/i3/config =====
